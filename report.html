<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Signalement Anonyme</title>
  <link rel="stylesheet" href="report.css">
  <style>
    /* --- Autocompl√©tion lieu --- */
    .location-input {
      position: relative;
      width: 100%;
      margin-top: 10px;
    }

    .location-input input {
      width: 100%;
      padding: 10px;
      border: 1px solid #aaa;
      border-radius: 10px;
      outline: none;
      font-size: 14px;
    }

    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-top: none;
      z-index: 10;
      max-height: 160px;
      overflow-y: auto;
      border-radius: 0 0 10px 10px;
    }

    .suggestion {
      padding: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .suggestion:hover {
      background: #e9f5ff;
    }

    /* --- Liste d√©roulante --- */
    .select-type {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #aaa;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
      background-color: white;
    }
  </style>
</head>
<body>
  <div class="phone-frame">
    <a href="index.html" class="back-btn">
      <span>‚Üê</span> Retour
    </a>

    <div class="logo">
      <img src="logo.png" alt="Malaw Security Logo" class="logo-image">
    </div>

    <h2>Signalement anonyme</h2>

    <textarea id="message" placeholder="Merci de faire une description ici..."></textarea>

    <!-- ‚úÖ Liste d√©roulante type d'alerte -->
    <select id="alertType" class="select-type">
      <option value="" disabled selected>üìã S√©lectionne le type d'alerte</option>
      <option value="Phishing">Phishing</option>
      <option value="Escroquerie">Escroquerie</option>
      <option value="Cyberattaque">Cyberattaque</option>
      <option value="Intrusion">Intrusion</option>
      <option value="Vol de donn√©es">Vol de donn√©es</option>
      <option value="Ran√ßongiciel">Ran√ßongiciel</option>
      <option value="Spam SMS">Spam SMS</option>
      <option value="Vishing">Vishing</option>
      <option value="Fraude livraison">Fraude √† la livraison</option>
      <option value="Autre">Autre</option>
    </select>

    <!-- ‚úÖ Champ de lieu avec suggestions -->
    <div class="location-input">
      <input
        type="text"
        id="locationInput"
        placeholder="üó∫Ô∏è Saisis le lieu (ville, r√©gion...)"
        autocomplete="off"
      />
      <div id="suggestions" class="suggestions" style="display:none;"></div>
    </div>

    <div class="options">
      <div class="option">
        <label for="photoInput">
          <img src="camera-icon.png" alt="Cam√©ra" title="Prendre ou choisir une photo">
        </label>
        <input 
          type="file" 
          id="photoInput" 
          accept="image/*" 
          capture="environment" 
          style="display: none;"
        >
      </div>

      <div class="option">
        <label for="anon">Anonyme</label>
        <label class="switch">
          <input type="checkbox" id="anon" checked>
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <button class="send-btn" id="sendBtn">Envoyer</button>
  </div>

  <script>
    const sendBtn = document.getElementById('sendBtn');
    const message = document.getElementById('message');
    const anonCheckbox = document.getElementById('anon');
    const photoInput = document.getElementById('photoInput');
    const locationInput = document.getElementById('locationInput');
    const suggestionsDiv = document.getElementById('suggestions');
    const alertType = document.getElementById('alertType');

    let localisation = "Non pr√©cis√©e";

    // ‚úÖ Autocompl√©tion du champ de localisation
    locationInput.addEventListener('input', async () => {
      const query = locationInput.value.trim();
      if (query.length < 2) {
        suggestionsDiv.style.display = "none";
        return;
      }

      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`);
        const data = await res.json();
        suggestionsDiv.innerHTML = "";

        if (data.length === 0) {
          suggestionsDiv.style.display = "none";
          return;
        }

        data.forEach(loc => {
          const region = loc.address.state || loc.address.region || loc.address.county || "";
          const item = document.createElement("div");
          item.classList.add("suggestion");
          item.textContent = `${loc.display_name}`;
          item.addEventListener("click", () => {
            locationInput.value = loc.display_name;
            localisation = region || loc.display_name;
            suggestionsDiv.style.display = "none";
          });
          suggestionsDiv.appendChild(item);
        });

        suggestionsDiv.style.display = "block";
      } catch (err) {
        console.error("Erreur API Nominatim :", err);
      }
    });

    // ‚úÖ Clic en dehors -> fermer suggestions
    document.addEventListener("click", (e) => {
      if (!locationInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
        suggestionsDiv.style.display = "none";
      }
    });

    // ‚úÖ Enregistrement du signalement
    sendBtn.addEventListener('click', () => {
      const text = message.value.trim();
      const type = alertType.value;

      if (!text) {
        alert("‚ö†Ô∏è Merci d‚Äô√©crire un message avant d‚Äôenvoyer !");
        return;
      }

      if (!type) {
        alert("‚ö†Ô∏è Merci de s√©lectionner un type d‚Äôalerte !");
        return;
      }

      const alerte = {
        date: new Date().toLocaleString(),
        localisation: localisation || locationInput.value || "Non pr√©cis√©e",
        description: text,
        categorie: type,
        statut: "Nouveau",
        anonyme: anonCheckbox.checked,
        image: photoInput.files[0]?.name || null
      };

      const alertes = JSON.parse(localStorage.getItem("alertes") || "[]");
      alertes.unshift(alerte);
      localStorage.setItem("alertes", JSON.stringify(alertes));

      sendBtn.textContent = "‚úÖ Envoy√© !";
      sendBtn.disabled = true;
      sendBtn.style.background = "linear-gradient(180deg,#43a047,#388e3c)";
      setTimeout(() => {
        sendBtn.textContent = "Envoyer";
        sendBtn.disabled = false;
        message.value = "";
        photoInput.value = "";
        locationInput.value = "";
        alertType.selectedIndex = 0;
        localisation = "Non pr√©cis√©e";
      }, 2500);
    });

    // ‚úÖ Option photo
    photoInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) alert("üì∏ Image s√©lectionn√©e : " + file.name);
    });
  </script>
</body>
</html>
